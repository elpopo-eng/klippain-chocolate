[gcode_macro _PRE_HOME_XY]
gcode:
    _DO_SENSORLESS_STUFF TYPE=HOME AXIS={params.AXIS}

[gcode_macro _POST_HOME_XY]
gcode:
    _DO_SENSORLESS_STUFF TYPE=RUN AXIS={params.AXIS}

[gcode_macro _DO_SENSORLESS_STUFF]
gcode:
    {% set AXIS = params.AXIS %}
    {% set TYPE = params.TYPE %}

    {% set kinematics = printer.configfile.config.printer.kinematics %}

    {% if printer["gcode_macro _USER_VARIABLES"].sensorless_homing_enabled %}
        {% if TYPE == 'RUN' %}
            M400
        {% endif %}
        {% if kinematics == "corexy" %}
            _SET_TMC_CURRENT AXIS=X TYPE={TYPE}
            _SET_TMC_CURRENT AXIS=Y TYPE={TYPE}
        {% elif kinematics == "corexz" %}
            {% if AXIS == 'X' %}
                _SET_TMC_CURRENT AXIS=X TYPE={TYPE}
                _SET_TMC_CURRENT AXIS=Z TYPE={TYPE}
            {% elif AXIS == 'Y' %}
                _SET_TMC_CURRENT AXIS=Y TYPE={TYPE}
            {% endif %}
        {% elif kinematics == "cartesian" %}
            _SET_TMC_CURRENT AXIS={AXIS} TYPE={TYPE}
        {% endif %}
        {% if TYPE == 'HOME' %}
            M400
        {% endif %}
    {% endif %}

[gcode_macro _SET_TMC_CURRENT]
gcode:
    {% set _u_vars = printer["gcode_macro _USER_VARIABLES"] %}
    
    {% set sensorless_current_factor = _u_vars.sensorless_current_factor|float / 100 %}
    {% set AXIS = params.AXIS|upper %}
    {% set TYPE = params.TYPE|upper %} #allowed values HOME | RUN
    {% set driver = _u_vars[AXIS|lower ~ '_driver'] %}
    
    {% if AXIS in 'XYZ' %}
        {% set current = printer.configfile.config[driver ~ ' stepper_' ~ AXIS|lower].run_current|float}
        {% if TYPE== 'HOME' %}
            {% set current = current * sensorless_current_factor %}
        {% endif %}
        SET_TMC_CURRENT STEPPER=stepper_{AXIS|lower} CURRENT={current}
    {% endif %}