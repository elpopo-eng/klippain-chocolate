[gcode_macro _PRE_HOME_XY]
gcode:
    _SET_DRIVERS MODE=HOME AXIS={params.AXIS}

[gcode_macro _POST_HOME_XY]
gcode:
    _SET_DRIVERS MODE=RUN AXIS={params.AXIS}

[gcode_macro _SET_DRIVERS]
gcode:
    {% set AXIS = params.AXIS %}
    {% set MODE = params.MODE %}

    {% set kinematics = printer.configfile.config.printer.kinematics %}

    M400
    {% if kinematics == "corexy" %}
        _SET_TMC AXIS=X MODE={TYPE}
        _SET_TMC AXIS=Y MODE={TYPE}
    {% elif kinematics == "corexz" %}
        {% if AXIS == 'X' %}
            _SET_TMC AXIS=X MODE={TYPE}
            _SET_TMC AXIS=Z MODE={TYPE}
        {% elif AXIS == 'Y' %}
            _SET_TMC AXIS=Y MODE={TYPE}
        {% endif %}
    {% elif kinematics == "cartesian" %}
        _SET_TMC AXIS={AXIS} MODE={TYPE}
    {% endif %}
    M400

[gcode_macro _SET_TMC]
gcode:
    {% set _u_vars = printer["gcode_macro _USER_VARIABLES"] %}
    
    {% set sensorless_current_factor = _u_vars.sensorless_current_factor|float / 100 %}
    {% set AXIS = params.AXIS|upper %}
    {% set MODE = params.MODE|upper %} #allowed values HOME | RUN
    {% set driver = _u_vars[AXIS|lower ~ '_driver'] %}
    
    {% if AXIS in 'XYZ' %}
        {% set current = printer.configfile.config[driver ~ ' stepper_' ~ AXIS|lower].run_current|float %}
        {% if MODE== 'HOME' %}
            {% set current = current * sensorless_current_factor %}
        {% endif %}
        SET_TMC_CURRENT STEPPER=stepper_{AXIS|lower} CURRENT={current}
    {% endif %}